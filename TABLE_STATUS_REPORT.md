# Azure Table Storage Status Report

## üìä Current Tables in Azure Storage

Based on your Azure Portal, you have **9 tables**:

### ‚úÖ **Required Tables (Present)**

1. **ApiKeys** ‚úÖ
   - **Status**: EXISTS
   - **Purpose**: Stores API keys and tenant associations
   - **Used by**: `src/lib/auth.ts`, `src/shared/validateApiKey.ts`
   - **Critical**: YES - Required for authentication

2. **AlertState** ‚úÖ
   - **Status**: EXISTS
   - **Purpose**: Tracks alert states to prevent duplicate notifications
   - **Used by**: `src/functions/uptimeCheck.ts`
   - **Critical**: YES - Required for uptime monitoring

3. **MonitoredUrls** ‚úÖ
   - **Status**: EXISTS
   - **Purpose**: Stores URLs being monitored for uptime checks
   - **Used by**: `src/functions/uptimeCheck.ts`
   - **Critical**: YES - Required for uptime monitoring

4. **UptimeChecks** ‚úÖ
   - **Status**: EXISTS
   - **Purpose**: Stores uptime check results
   - **Used by**: `src/functions/uptimeCheck.ts`
   - **Critical**: YES - Required for uptime monitoring

### ‚ùå **Missing Critical Table**

5. **SecurityAuditLog** ‚ùå **MISSING - MUST CREATE**
   - **Status**: DOES NOT EXIST
   - **Purpose**: Security audit event logs (authentication attempts, security events)
   - **Used by**: `src/shared/securityAudit.ts`
   - **Critical**: YES - Required for security audit logging we just implemented
   - **Impact**: Security audit logging will fail without this table

### ‚ùì **Additional Tables (Status Unknown)**

6. **Alerts** ‚ùì
   - **Status**: EXISTS (but not found in codebase)
   - **Purpose**: Unknown - may be legacy or for future use
   - **Action**: Verify if needed or can be removed

7. **Events** ‚ùì
   - **Status**: EXISTS (but not found in codebase)
   - **Purpose**: Unknown - may be legacy or for future use
   - **Note**: Events are stored in **Blob Storage** (`events` container), not Table Storage
   - **Action**: Verify if needed or can be removed

8. **WebhookEvents** ‚ùì
   - **Status**: EXISTS (but not found in codebase)
   - **Purpose**: Unknown - may be legacy or for future use
   - **Note**: Webhook events are stored in **Blob Storage** (`events` container)
   - **Action**: Verify if needed or can be removed

### üîß **System Tables (Auto-Generated)**

9. **AzureFunctionsDiagnosticEvents202512** üîß
   - **Status**: System-generated by Azure Functions
   - **Purpose**: Diagnostic logs for December 2025
   - **Action**: No action needed (auto-managed)

10. **AzureFunctionsDiagnosticEvents202601** üîß
    - **Status**: System-generated by Azure Functions
    - **Purpose**: Diagnostic logs for January 2026
    - **Action**: No action needed (auto-managed)

---

## üö® **Action Required**

### **CRITICAL: Create SecurityAuditLog Table**

The `SecurityAuditLog` table is **required** for the security audit logging feature we just implemented. Without it, security events will fail to log.

#### Option 1: Using the Script (Recommended)

```bash
# Set your connection string
export AzureWebJobsStorage="YOUR_CONNECTION_STRING"

# Run the script
node scripts/createMissingTables.js
```

#### Option 2: Using Azure Portal

1. Go to Azure Portal ‚Üí Storage Account ‚Üí `webhookmonitorstore`
2. Navigate to **Tables**
3. Click **+ Table**
4. Enter table name: `SecurityAuditLog`
5. Click **OK**

#### Option 3: Using Azure CLI

```bash
az storage table create \
  --name SecurityAuditLog \
  --account-name webhookmonitorstore \
  --connection-string "YOUR_CONNECTION_STRING"
```

---

## ‚úÖ **Table Requirements Summary**

### **Required for Core Functionality:**
- ‚úÖ `ApiKeys` - EXISTS
- ‚ùå `SecurityAuditLog` - **MISSING - MUST CREATE**

### **Required for Uptime Monitoring:**
- ‚úÖ `MonitoredUrls` - EXISTS
- ‚úÖ `UptimeChecks` - EXISTS
- ‚úÖ `AlertState` - EXISTS

### **Optional/Legacy:**
- ‚ùì `Alerts` - EXISTS (verify if needed)
- ‚ùì `Events` - EXISTS (verify if needed)
- ‚ùì `WebhookEvents` - EXISTS (verify if needed)

### **System-Managed:**
- üîß `AzureFunctionsDiagnosticEvents*` - Auto-generated

---

## üìã **Pre-Deployment Checklist**

- [ ] ‚úÖ `ApiKeys` table exists
- [ ] ‚ùå **Create `SecurityAuditLog` table** (CRITICAL)
- [ ] ‚úÖ `MonitoredUrls` table exists (if using uptime checks)
- [ ] ‚úÖ `UptimeChecks` table exists (if using uptime checks)
- [ ] ‚úÖ `AlertState` table exists (if using uptime checks)
- [ ] ‚ùì Verify if `Alerts`, `Events`, `WebhookEvents` are needed

---

## üîç **Verification Steps**

### 1. Check if SecurityAuditLog exists:

```bash
az storage table exists \
  --name SecurityAuditLog \
  --account-name webhookmonitorstore \
  --connection-string "YOUR_CONNECTION_STRING"
```

### 2. Create SecurityAuditLog if missing:

```bash
node scripts/createMissingTables.js
```

### 3. Verify all required tables:

```bash
az storage table list \
  --account-name webhookmonitorstore \
  --connection-string "YOUR_CONNECTION_STRING" \
  --query "[].name" -o table
```

---

## üìù **Notes**

1. **Tenants Table**: The code uses `devTenants.json` for local development, but tenant data may be stored elsewhere in production. Check if a `Tenants` table is needed.

2. **Blob Storage**: Webhook events are stored in **Blob Storage** (`events` container), not in Table Storage. The `Events` and `WebhookEvents` tables may be legacy.

3. **SecurityAuditLog**: This table is automatically created when the first security event is logged, but it's better to create it explicitly to avoid errors.

---

## üöÄ **Next Steps**

1. **IMMEDIATE**: Create `SecurityAuditLog` table using one of the methods above
2. **VERIFY**: Test security audit logging after deployment
3. **CLEANUP**: Determine if `Alerts`, `Events`, `WebhookEvents` tables are needed or can be removed
